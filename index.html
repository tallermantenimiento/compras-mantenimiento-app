<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras Mantenimiento · Panel</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --light: #ecf0f1;
            --border: #bdc3c7;
            --success: #27ae60;
            --danger: #c0392b;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f4f7f6; }
        
        /* Sidebar */
        .sidebar { width: 300px; background-color: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .logo { text-align: center; margin-bottom: 20px; }
        .logo img { max-width: 150px; }
        .app-title { font-size: 1.2rem; font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 5px; }
        .app-subtitle { font-size: 0.9rem; color: #7f8c8d; text-align: center; margin-bottom: 30px; }
        
        /* Formularios y Tablas Sidebar */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--secondary); }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
        button { background-color: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; transition: background 0.3s; }
        button:hover { background-color: var(--secondary); }
        .btn-danger { background-color: var(--danger); }
        .btn-danger:hover { background-color: #a93226; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: var(--light); }
        .active-row { background-color: #d5f5e3; }
        tr:hover { background-color: #f1f1f1; cursor: pointer; }

        /* Contenido Principal */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
        .section-title { font-size: 1.5rem; color: var(--primary); }
        .badge { background-color: var(--accent); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; }

        /* ESTILO IMPORTANTE PARA EL TEXTAREA DE COLUMNAS */
        .input-tabular {
            font-family: 'Courier New', Courier, monospace; /* Letra monoespaciada */
            white-space: pre; /* Mantiene el formato */
            min-height: 120px;
            overflow-x: auto;
            background-color: #fff;
        }

        /* Utilidades */
        .hidden { display: none; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .status-pill { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; }
        .status-pending { background-color: #f39c12; color: white; }
        .status-done { background-color: var(--success); color: white; }

        /* Estilo para el botón de toggle (historial) */
        .toggle-history {
            background: none; border: none; color: var(--accent); cursor: pointer; text-align: left; padding: 0; width: auto; text-decoration: underline; margin-top: 20px;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">
            <img src="./logo_sklum.jpg" alt="Logo" onerror="this.style.display='none'"> 
        </div>
        <div class="app-title">Compras Mantenimiento</div>
        <div class="app-subtitle">Panel de Control</div>

        <div class="form-group">
            <label>Gestión de sectores</label>
            <input type="text" id="newSectorName" placeholder="Nombre de sector (ej. Electricidad)">
        </div>
        <button onclick="createSector()">Crear sector</button>

        <div style="margin-top: 20px;">
            <strong>Sectores activos</strong>
            <table id="sectorsTable">
                <thead>
                    <tr>
                        <th>Sector</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div style="margin-top: auto; font-size: 0.8rem; color: #999;">
            <p>Los responsables usan la URL:<br> <strong>app_responsable.html?sector=CODIGO</strong></p>
        </div>
    </div>

    <div class="main-content">
        
        <div class="card">
            <h3 style="margin-top:0;">Crear pedido desde el panel</h3>
            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Referencia (Opcional)</label>
                    <input type="text" id="manualRef" placeholder="Ej. REF-001">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Sector Destino</label>
                    <select id="manualSectorSelect" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px;">
                        <option value="">Seleccione un sector...</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Material solicitado (Pega aquí tus celdas de Excel)</label>
                <textarea id="txtMaterial" class="input-tabular" placeholder="Pega aquí columnas copiadas de Excel o Tablas web..."></textarea>
            </div>
            <button onclick="createManualOrder()" style="width: auto;">Añadir Pedido</button>
        </div>

        <div class="header">
            <div class="section-title">Pedidos Activos <span id="activeSectorName" style="font-size: 1rem; color: #7f8c8d;">(Todos)</span></div>
            <span class="badge" id="pendingCount">0 pendientes</span>
        </div>

        <table id="ordersTable">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Sector</th>
                    <th>Referencia</th>
                    <th style="width: 40%;">Material</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="ordersBody">
                <tr><td colspan="6" style="text-align: center;">No hay pedidos pendientes</td></tr>
            </tbody>
        </table>

        <button class="toggle-history" onclick="toggleHistory()">Ver/Ocultar Pedidos Entregados ▼</button>
        
        <div id="historySection" class="hidden">
            <h3 style="margin-top: 20px; color: #7f8c8d;">Historial de Entregados</h3>
            <table id="historyTable" style="opacity: 0.7;">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Sector</th>
                        <th>Material</th>
                        <th>Estado</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>

    </div>

    <script>
        // --- LÓGICA DE DATOS (LocalStorage) ---
        let sectors = JSON.parse(localStorage.getItem('mto_sectors')) || [];
        let orders = JSON.parse(localStorage.getItem('mto_orders')) || [];

        function saveData() {
            localStorage.setItem('mto_sectors', JSON.stringify(sectors));
            localStorage.setItem('mto_orders', JSON.stringify(orders));
            renderAll();
        }

        // --- GESTIÓN DE SECTORES ---
        function createSector() {
            const name = document.getElementById('newSectorName').value;
            if (!name) return alert('Escribe un nombre');
            
            // Generar código simple aleatorio
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            sectors.push({ name, code, id: Date.now() });
            document.getElementById('newSectorName').value = '';
            saveData();
        }

        function deleteSector(id) {
            if(confirm('¿Borrar sector y sus pedidos?')) {
                sectors = sectors.filter(s => s.id !== id);
                orders = orders.filter(o => o.sectorId !== id); // Limpiar pedidos huérfanos
                saveData();
            }
        }

        // --- GESTIÓN DE PEDIDOS ---
        function createManualOrder() {
            const ref = document.getElementById('manualRef').value;
            const mat = document.getElementById('txtMaterial').value;
            const secId = document.getElementById('manualSectorSelect').value;

            if (!mat || !secId) return alert('Falta material o seleccionar sector');

            // Buscar nombre del sector
            const secObj = sectors.find(s => s.id == secId);
            
            orders.push({
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                ref: ref || '-',
                material: mat,
                sectorId: parseInt(secId),
                sectorName: secObj ? secObj.name : 'Unknown',
                status: 'pending'
            });

            document.getElementById('txtMaterial').value = '';
            document.getElementById('manualRef').value = '';
            saveData();
        }

        function markDelivered(id) {
            const order = orders.find(o => o.id === id);
            if (order) {
                order.status = 'delivered';
                saveData();
            }
        }

        function deleteOrder(id) {
            if(confirm('¿Eliminar pedido permanentemente?')) {
                orders = orders.filter(o => o.id !== id);
                saveData();
            }
        }

        // --- RENDERIZADO (DIBUJAR EN PANTALLA) ---
        function renderAll() {
            // 1. Render Sectores Sidebar
            const sBody = document.querySelector('#sectorsTable tbody');
            const sSelect = document.getElementById('manualSectorSelect');
            
            sBody.innerHTML = '';
            sSelect.innerHTML = '<option value="">Seleccione un sector...</option>';

            sectors.forEach(s => {
                // Tabla Sidebar
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:bold">${s.name}</div>
                        <div style="font-size:0.75rem; color:#888">Cód: ${s.code}</div>
                    </td>
                    <td><button class="btn-danger" style="padding:2px 5px; font-size:0.7rem;" onclick="deleteSector(${s.id})">X</button></td>
                `;
                sBody.appendChild(tr);

                // Select para pedido manual
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.innerText = s.name;
                sSelect.appendChild(opt);
            });

            // 2. Render Pedidos (Pendientes)
            const oBody = document.getElementById('ordersBody');
            oBody.innerHTML = '';
            
            const pendingOrders = orders.filter(o => o.status === 'pending');
            document.getElementById('pendingCount').innerText = `${pendingOrders.length} pendientes`;

            if (pendingOrders.length === 0) {
                oBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px; color: #999;">Todo entregado. ¡Buen trabajo!</td></tr>';
            } else {
                pendingOrders.forEach(o => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${o.date}</td>
                        <td>${o.sectorName}</td>
                        <td>${o.ref}</td>
                        <td style="white-space: pre-wrap; font-family: monospace;">${o.material}</td>
                        <td><span class="status-pill status-pending">Pendiente</span></td>
                        <td>
                            <button onclick="markDelivered(${o.id})" style="background-color:var(--success); width:auto; font-size:0.8rem;">Entregar</button>
                        </td>
                    `;
                    oBody.appendChild(tr);
                });
            }

            // 3. Render Historial
            const hBody = document.getElementById('historyBody');
            hBody.innerHTML = '';
            const deliveredOrders = orders.filter(o => o.status === 'delivered');

            deliveredOrders.forEach(o => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${o.date}</td>
                    <td>${o.sectorName}</td>
                    <td>${o.material.substring(0, 50)}...</td>
                    <td><span class="status-pill status-done">Entregado</span></td>
                    <td><button onclick="deleteOrder(${o.id})" class="btn-danger" style="padding:2px 5px;">X</button></td>
                `;
                hBody.appendChild(tr);
            });
        }

        function toggleHistory() {
            const sec = document.getElementById('historySection');
            sec.classList.toggle('hidden');
        }

        // --- AQUÍ ESTÁ LA MAGIA DEL PEGADO INTELIGENTE ---
        document.getElementById('txtMaterial').addEventListener('paste', function(e) {
            e.preventDefault();
            let clipboardData = (e.clipboardData || window.clipboardData).getData('text');
            let formattedText = formatTable(clipboardData);
            
            const selectionStart = this.selectionStart;
            const selectionEnd = this.selectionEnd;
            const currentVal = this.value;
            
            this.value = currentVal.substring(0, selectionStart) + formattedText + currentVal.substring(selectionEnd);
            this.selectionStart = this.selectionEnd = selectionStart + formattedText.length;
        });

        function formatTable(text) {
            let rows = text.split('\n').map(row => row.split('\t'));
            if (rows.length === 0 || (rows.length === 1 && rows[0].length < 2)) return text; // Si no es tabla, devolver normal

            // Calcular ancho máximo por columna
            let colWidths = [];
            rows.forEach(row => {
                row.forEach((cell, i) => {
                    let cellLen = (cell || '').trim().length;
                    if (!colWidths[i] || cellLen > colWidths[i]) colWidths[i] = cellLen;
                });
            });

            // Reconstruir con espacios
            return rows.map(row => {
                return row.map((cell, i) => {
                    let cellStr = (cell || '').trim();
                    return cellStr.padEnd(colWidths[i] + 4, ' '); // +4 espacios de margen
                }).join('').trimEnd();
            }).join('\n');
        }

        // Inicializar
        renderAll();

    </script>
</body>
</html>
